---
import { t } from '../i18n/utils';

interface Props {
  code: string;
  lang?: string;
  class?: string;
}

const { code, lang = 'en', class: className = '' } = Astro.props;
---

<div class:list={['copy-wrapper relative group', className]}>
  <pre class="bg-meok/5 dark:bg-meok/10 rounded-xl p-4 pr-12 overflow-x-auto text-sm font-code"><code set:text={code} /></pre>
  <button
    class="copy-btn absolute top-3 right-3 w-8 h-8 rounded-lg bg-changho/80 dark:bg-changho/20 text-onggi hover:text-hobak hover:bg-hobak-soft flex items-center justify-center opacity-0 group-hover:opacity-100 focus:opacity-100 transition-all duration-200 cursor-pointer"
    data-copy-text={code}
    aria-label={t('common.copyToClipboard', lang)}
    type="button"
  >
    <svg class="copy-icon w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
      <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
      <path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"></path>
    </svg>
    <svg class="check-icon w-4 h-4 hidden text-cheongja" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <path d="M5 12L10 17L20 7"></path>
    </svg>
  </button>
</div>

<script>
  document.addEventListener('click', async (e) => {
    const btn = (e.target as HTMLElement).closest('.copy-btn') as HTMLElement;
    if (!btn) return;

    const text = btn.dataset.copyText;
    if (!text) return;

    try {
      await navigator.clipboard.writeText(text);

      const copyIcon = btn.querySelector('.copy-icon') as HTMLElement;
      const checkIcon = btn.querySelector('.check-icon') as HTMLElement;

      if (copyIcon && checkIcon) {
        copyIcon.classList.add('hidden');
        checkIcon.classList.remove('hidden');

        setTimeout(() => {
          copyIcon.classList.remove('hidden');
          checkIcon.classList.add('hidden');
        }, 800);
      }
    } catch {
      // clipboard API 실패 시 무시
    }
  });
</script>
