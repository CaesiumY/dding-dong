---
import { Icon } from 'astro-icon/components';
import { t, tData, soundUrl } from '../i18n/utils';
import AudioPlayer from './AudioPlayer.astro';

interface Props {
  lang: string;
}

const { lang } = Astro.props;

interface TtsCard {
  icon: string;
  title: string;
  description: string;
}

const cards = tData<TtsCard[]>('ttsVoice.cards', lang);

// TTS 프리뷰 팩 배열 — 한국어/영어 각각 별도 팩 참조
const ttsPreviews = [
  { id: 'metro-voice', color: '#8B5CF6' },     // 한국어 — 보라
  { id: 'metro-voice-en', color: '#3B82F6' },   // 영어 — 파랑
];

// 두 팩 모두 동일 WAV 파일 참조
const metroManifestEvents: Record<string, { files: string[] }> = {
  'task.complete': { files: ['complete.wav'] },
  'task.error': { files: ['error.wav'] },
  'input.required': { files: ['input-required.wav'] },
  'session.start': { files: ['session-start.wav'] },
  'session.end': { files: ['session-end.wav'] },
};

const eventKeys = ['task.complete', 'task.error', 'input.required', 'session.start', 'session.end'] as const;

interface PreviewPack {
  packName: string;
  packDescription: string;
  events: Record<string, string>;
  onomatopoeia: Record<string, string>;
}
const previewPacks = tData<PreviewPack[]>('ttsVoice.preview.packs', lang) ?? [];
---

<section id="tts-voice" class="bg-misaek">
  <div class="py-24 md:py-32 lg:py-40 max-w-6xl mx-auto px-6 md:px-8 lg:px-12">
    <h2 class="text-(length:--text-h1) font-bold text-meok mb-4">
      {t('ttsVoice.heading', lang)}
    </h2>
    <p class="text-onggi text-lg mb-12">
      {t('ttsVoice.description', lang)}
    </p>

    <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
      {cards?.map((card) => (
        <div class="reveal rounded-2xl bg-hanji p-6 border border-changho">
          <Icon name={card.icon} class="w-8 h-8 text-hobak mb-4" />
          <h3 class="font-semibold text-lg text-meok mb-2">{card.title}</h3>
          <p class="text-onggi text-sm leading-relaxed">{card.description}</p>
        </div>
      ))}
    </div>

    <!-- TTS Voice Preview -->
    <div class="mt-12">
      <h3 class="text-xl font-semibold text-meok mb-2">
        {t('ttsVoice.preview.heading', lang)}
      </h3>
      <p class="text-onggi text-sm mb-6">
        {t('ttsVoice.preview.description', lang)}
      </p>

      <div class="grid md:grid-cols-2 gap-6">
        {ttsPreviews.map((pack, index) => {
          const packI18n = previewPacks[index];
          if (!packI18n) return null;
          return (
            <div
              class="rounded-2xl bg-hanji border border-changho border-l-4"
              style={`border-left-color: ${pack.color};`}
            >
              <div class="p-5 pb-0">
                <div class="flex items-center gap-2.5 mb-1">
                  <span
                    class="w-3 h-3 rounded-full shrink-0"
                    style={`background-color: ${pack.color};`}
                  ></span>
                  <span class="font-semibold text-meok">
                    {packI18n.packName}
                  </span>
                </div>
                <p class="text-sm text-onggi pl-5">
                  {packI18n.packDescription}
                </p>
              </div>
              <div class="border-t border-changho/50 mx-5 my-3"></div>
              <div class="px-3 pb-3">
                {eventKeys.map((eventKey) => {
                  const file = metroManifestEvents[eventKey]?.files?.[0];
                  const url = file ? soundUrl(pack.id, file) : '';
                  return (
                    <AudioPlayer
                      soundUrl={url}
                      packColor={pack.color}
                      onomatopoeia={packI18n.onomatopoeia[eventKey] ?? eventKey}
                      eventLabel={packI18n.events[eventKey] ?? eventKey}
                    />
                  );
                })}
              </div>
            </div>
          );
        })}
      </div>
    </div>

  </div>
</section>

<script src="../scripts/audio-player.ts"></script>
